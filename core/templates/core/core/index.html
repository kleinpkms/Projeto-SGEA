<!DOCTYPE html>
{% load static %}
<html lang="pt-br">
<head>
	<meta charset="UTF-8">
	<title>SGEA - Home</title>
	<link rel="stylesheet" href="{% static 'css/style.css' %}">
	<meta name="viewport" content="width=device-width,initial-scale=1">
</head>
<body>
	<header>
		<div class="logo">SGEA ðŸŽ“</div>
		<nav>
			<div class="nav-right">
				{% if show_admin %}
					<a href="/admin-area/" class="btn" style="margin-right:8px; padding:8px 12px; background:transparent; color:white; border:1px solid rgba(255,255,255,0.18);">Admin</a>
				{% endif %}
				<div class="user-greeting-wrap" style="position:relative;">
								<div style="display:flex;align-items:center;gap:8px;">
									{% if request.user.profile and request.user.profile.photo %}
										<img src="{{ request.user.profile.photo.url }}" alt="Avatar" style="width:36px;height:36px;border-radius:999px;object-fit:cover;vertical-align:middle;" />
									{% else %}
										<div style="width:36px;height:36px;border-radius:999px;background:#eaf4fb;color:#0a58ca;display:flex;align-items:center;justify-content:center;font-weight:700;">{{ request.user.first_name|default:request.user.username|slice:":1"|upper }}</div>
									{% endif %}
									<div class="user-greeting" id="user-greeting">OlÃ¡, {{ user.username|default:"UsuÃ¡rio" }}</div>
								</div>
					<div id="user-hud" style="display:none;position:absolute;right:0;top:calc(100% + 8px);background:#fff;border:1px solid #e3e3e3;padding:10px;border-radius:8px;box-shadow:0 8px 30px rgba(0,0,0,0.08);min-width:240px;z-index:40;">
							<div style="display:flex;gap:10px;align-items:center;margin-bottom:8px;">
								{% if request.user.profile and request.user.profile.photo %}
									<img src="{{ request.user.profile.photo.url }}" alt="Avatar" class="avatar-img">
								{% else %}
									<div class="avatar-fallback">{{ request.user.first_name|default:request.user.username|slice:":1"|upper }}</div>
								{% endif %}
								<div style="flex:1;">
									<div style="font-weight:700;">{{ user.get_full_name|default:user.username }}</div>
									<div style="font-size:0.9rem;color:#555;">{{ user.email }}</div>
								</div>
							</div>
							<div style="display:flex;gap:8px;">
								<a href="/perfil/" class="btn" style="flex:1;padding:8px 10px;">Dados pessoais</a>
								<a href="/perfil/alterar-senha/" class="btn secondary" style="flex:1;padding:8px 10px;">Alterar senha</a>
							</div>
						</div>
				</div>
				<form method="post" action="/sair/" style="display:inline; margin:0;">
					{% csrf_token %}
					<button type="submit" class="logout-btn">Sair</button>
				</form>
			</div>
		</nav>
	</header>
	<script>
	// show HUD on hover with small delay to avoid flicker
	(function(){
		const wrap = document.querySelector('.user-greeting-wrap');
		const hud = document.getElementById('user-hud');
		if(!wrap || !hud) return;
		let tid;
		wrap.addEventListener('mouseenter', function(){ clearTimeout(tid); hud.style.display='block'; });
		wrap.addEventListener('mouseleave', function(){ tid = setTimeout(()=>hud.style.display='none', 200); });
		// also allow focus accessibility
		const greeting = document.getElementById('user-greeting');
		if(greeting){ greeting.setAttribute('tabindex','0'); greeting.addEventListener('focus', ()=>{ clearTimeout(tid); hud.style.display='block'}); greeting.addEventListener('blur', ()=>{ tid=setTimeout(()=>hud.style.display='none',200); }); }
	})();

	// (deprecated) inscreverHandler kept for compatibility but will not be used
	function inscreverHandler(ev, eventId){
		try{ ev.preventDefault(); ev.stopPropagation(); }catch(e){}
	}
	</script>
	<script>
	// toggle show/hide for certificates table
	(function(){
		document.addEventListener('DOMContentLoaded', function(){
			const btn = document.getElementById('toggle-cert-btn');
			const card = document.getElementById('certificates-card');
			if(!btn || !card) return;
			const table = card.querySelector('table');
			btn.addEventListener('click', function(){
				if(!table) return;
				if(table.style.display === 'none'){
					table.style.display = '';
					btn.textContent = 'Ocultar certificados';
				} else {
					table.style.display = 'none';
					btn.textContent = 'Mostrar certificados';
				}
			});
		});
	})();
	</script>

	<div class="container">
		<div class="card hero">
			<div>
				<h1>Bem-vindo ao SGEA</h1>
				<p>Sistema de GestÃ£o de Eventos AcadÃªmicos. Gerencie seus eventos e certificados.</p>
			</div>
		</div>

		<div class="card">
			<h2>Feed de Eventos</h2>
			<div class="event-feed" role="list">
				{% for item in feed_events %}
				{% with evento=item.evento %}
				<article class="event-card" role="listitem" data-event-id="{{ evento.id }}">
					<div class="event-banner">
						{% if evento.banner %}
							<img src="{{ evento.banner.url }}" alt="Banner {{ evento.nome }}">
						{% else %}
							{{ evento.nome|truncatechars:18 }}
						{% endif %}
					</div>
					<div class="event-body">
						<div class="event-title">{{ evento.nome }}</div>
						<div style="color:#007acc; font-size:0.95rem;">ResponsÃ¡vel: {{ evento.responsavel.get_full_name|default:evento.responsavel.username }}</div>
						<div class="event-desc">{{ evento.descricao|default:"(sem descriÃ§Ã£o)" }}</div>
						<div class="event-meta">
							<div>{{ evento.data_inicio|date:"d/m/Y" }}</div>
							<div>{{ evento.data_inicio|time:"H:i" }} â€” {{ evento.data_fim|time:"H:i" }}</div>
							<div>{{ evento.carga_horaria_readable }}</div>
							<div class="vacancy">Vagas: {{ item.remaining }}</div>
							<div class="event-actions">
								{% if item.is_inscrito %}
									<button class="btn small disabled" disabled style="margin-right:6px;">Inscrito</button>
									<form method="post" class="cancel-inline confirmable" data-event-id="{{ evento.id }}" data-confirm="Tem certeza que deseja cancelar sua inscriÃ§Ã£o?" style="display:inline">
										{% csrf_token %}
										<input type="hidden" name="evento_id" value="{{ evento.id }}">
										<button type="submit" class="btn small" style="background:#c33;color:#fff;">Cancelar</button>
									</form>
								{% elif item.remaining > 0 %}
									<form method="post" class="inscrever-form" data-event-id="{{ evento.id }}">
										{% csrf_token %}
										<input type="hidden" name="evento" value="{{ evento.id }}">
										<button type="submit" class="btn small inscrever-btn">Inscrever-se</button>
									</form>
								{% else %}
									<button class="btn small disabled" disabled>Lotado</button>
								{% endif %}
							</div>
						</div>
					</div>
				</article>
				{% endwith %}
				{% empty %}
				<div class="alert">Nenhum evento encontrado.</div>
				{% endfor %}
			</div>

			{% if page_obj.has_next %}
				<div style="text-align:center; margin-top:12px;">
					<a href="?page={{ page_obj.next_page_number }}" class="btn load-more">Carregar mais</a>
				</div>
			{% endif %}
		</div>

		<div class="grid grid-center">
			<div id="certificates-card" class="card" style="max-width:950px; width:100%;">
				<div style="display:flex;align-items:center;justify-content:center;gap:12px;">
					<h2 style="margin:0;">Meus Eventos e Certificados</h2>
					<button id="toggle-cert-btn" class="btn small" style="margin-left:8px;">Ocultar certificados</button>
				</div>
				<table>
					<thead>
						<tr>
							<th>Evento</th>
							<th>Status</th>
							<th>AÃ§Ã£o</th>
						</tr>
					</thead>
					<tbody>
					{% for ins in inscricoes %}
					<tr>
						<td>{% if ins.evento %}{{ ins.evento.nome }}{% else %}{{ ins.certificado_evento_nome|default:"(evento removido)" }}{% endif %}</td>
						<td>{% if ins.presenca_confirmada %}<span style="color:#008c6e;font-weight:bold;">PresenÃ§a Confirmada</span>{% else %}<span style="color:#ff8c00;font-weight:700;">ConfirmaÃ§Ã£o pendente</span>{% endif %}</td>
						<td style="text-align:center;">
							{% if ins.certificado_gerado and ins.presenca_confirmada %}
									<a href="{% url 'baixar_certificado' ins.id %}" class="btn" target="_blank">ðŸ“„ Certificado</a>
								{% else %}
								{% if ins.evento and ins.evento.data_fim <= now and not ins.presenca_confirmada %}
									<a href="{% url 'confirmar_codigo_participante' ins.id %}" class="btn small">Confirmar presenÃ§a</a>
								{% else %}
									â€”
								{% endif %}
							{% endif %}
						</td>
					</tr>
					{% empty %}
					<tr><td colspan="3">VocÃª nÃ£o possui inscriÃ§Ãµes.</td></tr>
					{% endfor %}
					</tbody>
				</table>
			</div>
		</div>
	</div>
	<script>
	// Ajax-based load-more that appends cards instead of navigating pages
	(function(){
		document.addEventListener('click', function(ev){
			const a = ev.target.closest && ev.target.closest('.load-more');
			if(!a) return;
			ev.preventDefault();
			const url = a.getAttribute('href');
			fetch(url, {credentials: 'same-origin'}).then(r=>r.text()).then(html=>{
				const parser = new DOMParser();
				const doc = parser.parseFromString(html, 'text/html');
				const newCards = doc.querySelectorAll('.event-card');
				const feed = document.querySelector('.event-feed');
				newCards.forEach(c=>{ feed.appendChild(c); });
				// replace or remove load-more link
				const newLoad = doc.querySelector('.load-more');
				if(newLoad){ a.href = newLoad.getAttribute('href'); } else { a.remove(); }
			}).catch(err=>{ console.error(err); alert('Falha ao carregar mais eventos.'); });
		});
	})();

	// cancel inline forms: submit via fetch to cancel an existing inscription
	(function(){
		// wait for DOMContentLoaded then show it. If modal is missing, create it programmatically
		// so we never fall back to the browser `confirm` dialog.
		function showSiteConfirm(msg){
			return new Promise(function(resolve){
				function attachAndShow(){
					let overlay = document.getElementById('site-confirm-overlay');
					let siteMsg = document.getElementById('site-confirm-msg');
					let yes = document.getElementById('site-confirm-yes');
					let no = document.getElementById('site-confirm-no');
					// if missing, create programmatically so we never use native confirm
					if(!(overlay && siteMsg && yes && no)){
						const container = document.createElement('div');
						container.innerHTML = '\n  <div id="site-confirm-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:9998;align-items:center;justify-content:center;">\n    <div id="site-confirm" style="background:#fff;padding:18px;border-radius:10px;max-width:420px;width:94%;box-shadow:0 12px 40px rgba(0,0,0,0.2);">\n      <div id="site-confirm-msg" style="font-size:1rem;color:#222;margin-bottom:12px;"></div>\n      <div style="display:flex;gap:10px;justify-content:flex-end;">\n        <button id="site-confirm-no" class="btn secondary" style="background:transparent;color:#b30000;border:1px solid rgba(0,0,0,0.06);">NÃ£o</button>\n        <button id="site-confirm-yes" class="btn" style="background:#28a745;">Sim</button>\n      </div>\n    </div>\n  </div>\n';
						document.body.appendChild(container);
						overlay = document.getElementById('site-confirm-overlay');
						siteMsg = document.getElementById('site-confirm-msg');
						yes = document.getElementById('site-confirm-yes');
						no = document.getElementById('site-confirm-no');
					}
					siteMsg.textContent = msg || 'Tem certeza?';
					overlay.style.display = 'flex';
					function cleanup(){ overlay.style.display='none'; yes.removeEventListener('click', onYes); no.removeEventListener('click', onNo); }
					function onYes(){ cleanup(); resolve(true); }
					function onNo(){ cleanup(); resolve(false); }
					yes.addEventListener('click', onYes);
					no.addEventListener('click', onNo);
				}
				// try immediately, otherwise wait for DOMContentLoaded
				if(document.readyState === 'complete' || document.readyState === 'interactive'){
					attachAndShow();
				} else {
					document.addEventListener('DOMContentLoaded', attachAndShow, {once:true});
				}
			});
		}

		document.addEventListener('submit', function(ev){
			const f = ev.target;
			if(f.classList && f.classList.contains('cancel-inline')){
				ev.preventDefault();
				const confMsg = f.getAttribute('data-confirm');
				if(f.classList && f.classList.contains('confirmable')){
					showSiteConfirm(confMsg || 'Tem certeza que deseja cancelar sua inscriÃ§Ã£o?').then(function(ok){
						if(!ok) return;
						try{ f.classList.remove('confirmable'); }catch(e){}
						const fd = new FormData(f);
						fetch('{% url "cancelar_minha_inscricao" %}', {method:'POST', body: fd, credentials:'same-origin', headers: {'X-CSRFToken': fd.get('csrfmiddlewaretoken')}})
						.then(r=>{ if(r.ok) location.reload(); else alert('Falha ao cancelar'); })
						.catch(()=> alert('Erro'))
					});
				} else {
					const fd = new FormData(f);
					fetch('{% url "cancelar_minha_inscricao" %}', {method:'POST', body: fd, credentials:'same-origin', headers: {'X-CSRFToken': fd.get('csrfmiddlewaretoken')}})
					.then(r=>{ if(r.ok) location.reload(); else alert('Falha ao cancelar'); })
					.catch(()=> alert('Erro'))
				}
			}
		});
	})();

						// helper to update the vacancy counter in the UI for an event
						function updateVacancy(eventId, delta){
							try{
								const root = document.querySelector('[data-event-id="'+eventId+'"]');
								if(!root) return;
								const vacEl = root.querySelector('.vacancy');
								if(!vacEl) return;
								const m = (vacEl.textContent||'').match(/\d+/);
								if(!m) return;
								let n = parseInt(m[0],10) + (delta||0);
								if(isNaN(n) || n<0) n = 0;
								vacEl.textContent = 'Vagas: '+n;
							}catch(e){ console.error('updateVacancy error', e); }
						}

						// create a cancel-inline form DOM and replace the inscrever-form
						function createCancelInline(eventId, csrfToken){
							try{
								if(!eventId) return;
								const root = document.querySelector('[data-event-id="'+eventId+'"]');
								if(!root) return;
								const actions = root.querySelector('.event-actions');
								if(!actions) return;
								// if an inscrever-form exists, keep it but mark as Inscrito; otherwise create a disabled label
								const insForm = actions.querySelector('.inscrever-form');
								// build cancel form
								const form = document.createElement('form');
								form.method = 'post';
								form.className = 'cancel-inline confirmable';
								form.setAttribute('data-event-id', eventId);
								form.style.display = 'inline';
								// hidden csrf
								if(csrfToken){
									const inp = document.createElement('input'); inp.type='hidden'; inp.name='csrfmiddlewaretoken'; inp.value = csrfToken; form.appendChild(inp);
								}
								// hidden evento_id
								const hid = document.createElement('input'); hid.type='hidden'; hid.name='evento_id'; hid.value = eventId; form.appendChild(hid);
								// button
								const btn = document.createElement('button'); btn.type='submit'; btn.className='btn small'; btn.style.background='#c33'; btn.style.color='#fff'; btn.textContent='Cancelar';
								form.appendChild(btn);
								if(insForm){
									// mark existing inscrever button as Inscrito and keep it
									try{
										const ib = insForm.querySelector('.inscrever-btn');
										if(ib){ ib.textContent = 'Inscrito'; ib.disabled = true; ib.classList.add('disabled'); }
									}catch(e){}
									// insert cancel after the inscrever form
									if(insForm.nextSibling) actions.insertBefore(form, insForm.nextSibling); else actions.appendChild(form);
								} else {
									// no inscrever form present (edge case) - insert a disabled Inscrito button then cancel
									try{
										const b = document.createElement('button'); b.type='button'; b.className='btn small disabled'; b.disabled = true; b.textContent = 'Inscrito'; actions.insertBefore(b, actions.firstChild);
									}catch(e){}
									actions.insertBefore(form, actions.firstChild);
								}
							}catch(e){ console.error('createCancelInline error', e); }
						}
	</script>
	<script>
	// single consolidated inscrever handlers: capture submit and click fallback
	(function(){
		function ensureModalExists(){
			if(document.getElementById('site-confirm-overlay')) return;
			const container = document.createElement('div');
			container.innerHTML = '\n  <div id="site-confirm-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:9998;align-items:center;justify-content:center;">\n    <div id="site-confirm" style="background:#fff;padding:18px;border-radius:10px;max-width:420px;width:94%;box-shadow:0 12px 40px rgba(0,0,0,0.2);">\n      <div id="site-confirm-msg" style="font-size:1rem;color:#222;margin-bottom:12px;"></div>\n      <div style="display:flex;gap:10px;justify-content:flex-end;">\n        <button id="site-confirm-no" class="btn secondary" style="background:transparent;color:#b30000;border:1px solid rgba(0,0,0,0.06);">NÃ£o</button>\n        <button id="site-confirm-yes" class="btn" style="background:#28a745;">Sim</button>\n      </div>\n    </div>\n  </div>\n';
			document.body.appendChild(container);
		}

		async function postInscricaoFromForm(f){
			try{
				// prevent duplicate submissions
				if(f.dataset.submitting === '1') return false;
				f.dataset.submitting = '1';
				const fd = new FormData(f);
				const url = f.getAttribute('action') || window.location.origin + '/api/inscricoes/';
				const r = await fetch(url, {method: 'POST', body: fd, credentials: 'same-origin', headers: {'X-CSRFToken': fd.get('csrfmiddlewaretoken')}});
				let j = {};
				try{ j = await r.json(); }catch(e){}
				const eid = f.getAttribute('data-event-id') || fd.get('evento');
				if(r.ok){
					const btn = f.querySelector('.inscrever-btn');
					if(btn){ btn.textContent = 'Inscrito'; btn.disabled = true; btn.classList.add('disabled'); }
					try{ updateVacancy(eid, -1); createCancelInline(eid, fd.get('csrfmiddlewaretoken')); }catch(e){}
					return true;
				} else {
					const msg = (j && (j.error || j.detail)) || ('Falha ao inscrever (status '+r.status+')');
					alert(msg);
					return false;
				}
			}catch(err){ console.error('postInscricaoFromForm error', err); alert('Erro de rede ao inscrever'); return false; }
			finally{ try{ delete f.dataset.submitting; }catch(e){} }
		}

		document.addEventListener('submit', function(ev){
			const f = ev.target;
			if(!(f && f.classList && f.classList.contains('inscrever-form'))) return;
			ev.preventDefault();
			postInscricaoFromForm(f);
		}, true);

		document.addEventListener('click', function(ev){
			const btn = ev.target.closest && ev.target.closest('.inscrever-btn');
			if(!btn) return;
			ev.preventDefault();
			const f = btn.closest('form');
			if(!f) return;
			postInscricaoFromForm(f);
		}, true);

		// ensure modal exists so cancelable actions always use site modal
		document.addEventListener('DOMContentLoaded', function(){ ensureModalExists(); });
	})();
	</script>
</body>
</html>