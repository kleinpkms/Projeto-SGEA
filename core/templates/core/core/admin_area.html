<!DOCTYPE html>
<html lang="pt-br">
<head>
	<meta charset="UTF-8">
	<title>Admin √Årea - SGEA</title>
	<link rel="stylesheet" href="/static/css/style.css">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<style>
		.container { max-width: 900px; margin: 2.5rem auto; padding: 0 1rem; }
		.header { display:flex; justify-content:space-between; align-items:center; }
		.stats { display:flex; gap:12px; margin-top:18px; }
		.stat { background:#fff; padding:18px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.04); flex:1; text-align:center }
		.recent { margin-top:18px; }
	</style>
</head>
<body>
	<div class="container">
		<div class="header">
			<h2>√Årea Administrativa</h2>
			<div style="display:flex;gap:8px;align-items:center;">
				{% if can_create %}
				<button id="toggle-events-hud" class="btn primary" style="min-width:120px;padding:10px 18px;">Criar Evento</button>
				{% endif %}
				{% if show_audit_button %}
				<button id="open-audit" class="btn" style="min-width:120px;padding:10px 18px;" onclick="location.href='{% url 'admin_auditoria' %}'">Auditoria</button>
				{% endif %}
				<button type="button" class="btn secondary" style="min-width:120px;padding:10px 18px;" onclick="location.href='/home/'">Voltar</button>
			</div>
		</div>
		{% if message %}
			<div class="alert {% if message_type == 'success' %}alert-success{% else %}alert-danger{% endif %}" style="margin-top:12px">{{ message }}</div>
		{% endif %}

		<div id="events-hud" style="display:none">
		<div class="card" style="margin-top:18px;">
			<h3 id="hud-title">Criar novo evento</h3>
			<form id="create-event-form" method="post" enctype="multipart/form-data">
				{% csrf_token %}
				<input type="hidden" name="action" value="create_event">
				<div style="display:flex; flex-direction:column; gap:10px;">
					<label>Nome</label>
					<input name="nome" id="ev-nome" required>
					<label>Descri√ß√£o</label>
					<textarea name="descricao" id="ev-descricao" rows="6" required style="min-height:140px;"></textarea>
					<div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start;">
						<div style="flex:1; min-width:220px;">
							<label>Data (in√≠cio)</label>
							<input type="date" name="data_inicio" id="data_inicio_date" required style="width:100%;">
							<label>Hora (in√≠cio)</label>
							<div style="display:flex; gap:8px; align-items:flex-start;">
								<input type="time" name="hora_inicio" id="hora_inicio" required style="width:100%;">
								<div id="start-shortcuts" style="display:none; background:#fff; border:1px solid #ddd; padding:6px; box-shadow:0 6px 18px rgba(0,0,0,0.08);">
									<div style="display:flex; justify-content:space-between; align-items:center;">
										<strong style="font-size:0.9rem;">Atalhos</strong>
										<button type="button" class="close-shortcuts" data-target="start-shortcuts" style="background:#ff4d4f;color:#fff;border:none;border-radius:3px;padding:2px 6px;">‚úï</button>
									</div>
									<div style="display:flex; flex-direction:column; gap:6px; margin-top:6px;">
										<button type="button" class="btn time-shortcut" style="padding:6px 10px; font-size:0.85rem; display:block;" data-target="hora_inicio" data-time="06:00">06:00</button>
										<button type="button" class="btn time-shortcut" style="padding:6px 10px; font-size:0.85rem; display:block;" data-target="hora_inicio" data-time="12:00">12:00</button>
										<button type="button" class="btn time-shortcut" style="padding:6px 10px; font-size:0.85rem; display:block;" data-target="hora_inicio" data-time="18:00">18:00</button>
										<button type="button" class="btn time-shortcut" style="padding:6px 10px; font-size:0.85rem; display:block;" data-target="hora_inicio" data-time="00:00">00:00</button>
										<button type="button" class="btn time-shortcut" style="padding:6px 10px; font-size:0.85rem; display:block;" data-target="both" data-time="now">Agora</button>
									</div>
								</div>
							</div>
						</div>
						<div style="flex:1; min-width:220px;">
							<label>Data (fim)</label>
							<input type="date" name="data_fim" id="data_fim_date" required style="width:100%;">
							<label>Hora (fim)</label>
							<div style="display:flex; gap:8px; align-items:flex-start;">
								<input type="time" name="hora_fim" id="hora_fim" required style="width:100%;">
								<div id="end-shortcuts" style="display:none; background:#fff; border:1px solid #ddd; padding:6px; box-shadow:0 6px 18px rgba(0,0,0,0.08);">
									<div style="display:flex; justify-content:space-between; align-items:center;">
										<strong style="font-size:0.9rem;">Atalhos</strong>
										<button type="button" class="close-shortcuts" data-target="end-shortcuts" style="background:#ff4d4f;color:#fff;border:none;border-radius:3px;padding:2px 6px;">‚úï</button>
									</div>
									<div style="display:flex; flex-direction:column; gap:6px; margin-top:6px;">
										<button type="button" class="btn time-shortcut" style="padding:6px 10px; font-size:0.85rem; display:block;" data-target="hora_fim" data-time="06:00">06:00</button>
										<button type="button" class="btn time-shortcut" style="padding:6px 10px; font-size:0.85rem; display:block;" data-target="hora_fim" data-time="12:00">12:00</button>
										<button type="button" class="btn time-shortcut" style="padding:6px 10px; font-size:0.85rem; display:block;" data-target="hora_fim" data-time="18:00">18:00</button>
										<button type="button" class="btn time-shortcut" style="padding:6px 10px; font-size:0.85rem; display:block;" data-target="hora_fim" data-time="00:00">00:00</button>
										<button type="button" class="btn time-shortcut" style="padding:6px 10px; font-size:0.85rem; display:block;" data-target="both" data-time="now">Agora</button>
									</div>
								</div>
							</div>
						</div>
					</div>
					<label>Local</label>
					<input name="local" id="ev-local" required>
					<label>Vagas</label>
					<input type="number" name="vagas" id="ev-vagas" min="1" value="10" required>
					<label>Banner</label>
					<input type="file" name="banner" id="ev-banner" accept="image/*">
					<div style="display:flex; gap:10px; align-items:center;">
						<div id="carga-preview" style="font-weight:700;">Carga: ‚Äî</div>
					</div>
					<div style="margin-top:10px;">
						<button class="btn" type="submit">Criar evento</button>
					</div>
				</div>
				<div style="flex-basis:100%;">
					<label>Respons√°vel</label>
					<select name="responsavel" id="ev-responsavel" style="width:100%;">
						{% for u in responsaveis %}
							<option value="{{ u.id }}" {% if request.user.id == u.id %}selected{% endif %}>{{ u.get_full_name|default:u.username }}</option>
						{% endfor %}
					</select>
				</div>
			</form>
		</div>

		<script>
		document.addEventListener('DOMContentLoaded', function(){
			(function(){
				const hud = document.getElementById('events-hud');
				const toggle = document.getElementById('toggle-events-hud');
				const form = document.getElementById('create-event-form');
				const submitBtn = form.querySelector('button[type="submit"]');
				let editMode = false;
				window.evEditMode = false;
				let editingId = null;

				toggle.addEventListener('click', function(){
					hud.style.display = hud.style.display === 'none' ? 'block' : 'none';
					if(hud.style.display === 'block') window.scrollTo({top: hud.offsetTop - 40, behavior: 'smooth'});
				});

				function resetForm(){
					editMode = false; editingId = null;
					window.evEditMode = false;
					window.editingId = null;
					form.action = '';
					form.querySelector('input[name="action"]').value = 'create_event';
					submitBtn.textContent = 'Criar evento';
					// oculta o HUD ao cancelar
					hud.style.display = 'none';
					document.getElementById('hud-title').textContent = 'Criar novo evento';
					const hiddenStart = document.getElementById('hidden_start'); if(hiddenStart) hiddenStart.remove();
					const hiddenEnd = document.getElementById('hidden_end'); if(hiddenEnd) hiddenEnd.remove();
					form.reset();
					document.getElementById('carga-preview').textContent = 'Carga: ‚Äî';
				}

				document.querySelectorAll('.edit-ev').forEach(function(b){
					b.addEventListener('click', function(){
						const data = JSON.parse(b.getAttribute('data-ev'));
						hud.style.display = 'block';
						document.getElementById('hud-title').textContent = 'Modificar evento';
						// populate form
						document.getElementById('ev-nome').value = data.nome || '';
						document.getElementById('ev-descricao').value = data.descricao || '';
						// parse ISO datetimes into date and time parts
						function setDateTimeParts(iso, dateId, timeId){
							if(!iso) return;
							// parse ISO-ish string without relying on Date (avoids timezone shifts)
							// iso is like "YYYY-MM-DDTHH:MM:SS+00:00" or "YYYY-MM-DDTHH:MM:SSZ"
							const parts = iso.split('T');
							if(parts.length<2) return;
							const datePart = parts[0];
							let timePart = parts[1] || '';
							// remove timezone offset if present
							timePart = timePart.split(/[+-Z]/)[0];
							const hhmm = timePart.split(':');
							const hour = ('0'+(hhmm[0]||0)).slice(-2);
							const minute = ('0'+(hhmm[1]||0)).slice(-2);
							document.getElementById(dateId).value = datePart;
							document.getElementById(timeId).value = `${hour}:${minute}`;
						}
						setDateTimeParts(data.data_inicio, 'data_inicio_date', 'hora_inicio');
						setDateTimeParts(data.data_fim, 'data_fim_date', 'hora_fim');
						document.getElementById('ev-local').value = data.local || '';
						document.getElementById('ev-vagas').value = data.vagas || 10;
						// set responsavel select if present in payload
						try{ if(data.responsavel_id) document.getElementById('ev-responsavel').value = data.responsavel_id; }catch(e){}
						// set edit mode
						editMode = true; editingId = data.id;
						window.evEditMode = true;
						window.editingId = data.id;
						form.querySelector('input[name="action"]').value = 'edit_event';
						// ensure a hidden input with event_id
						let hid = document.getElementById('event_id_field');
						if(!hid){ hid = document.createElement('input'); hid.type='hidden'; hid.name='event_id'; hid.id='event_id_field'; form.appendChild(hid); }
						hid.value = editingId;
						submitBtn.textContent = 'Salvar altera√ß√µes';
						updateCarga();
					});
				});

				// adicionar bot√£o de cancelar
				const cancelBtn = document.createElement('button'); cancelBtn.type='button'; cancelBtn.className='btn'; cancelBtn.style.marginLeft='8px'; cancelBtn.textContent='Cancelar';
				cancelBtn.addEventListener('click', resetForm);
				// avoid duplicating cancel button
				cancelBtn.classList.add('cancel-event-cancel');
				if(!submitBtn.parentNode.querySelector('button.cancel-event-cancel')){
					submitBtn.parentNode.appendChild(cancelBtn);
				}
				// expose for AJAX handlers to reset state
				window.resetEventForm = resetForm;

				// fecha atalhos ao clicar fora (acesso seguro aos elementos)
				document.addEventListener('click', function(ev){
					setTimeout(function(){
						try{
							var timeShortcutsEl = document.getElementById('start-shortcuts');
							var endShortcutsEl = document.getElementById('end-shortcuts');
							var startTimeInput = document.getElementById('hora_inicio');
							var endTimeInput = document.getElementById('hora_fim');
							var active = document.activeElement;
							if(timeShortcutsEl && (!timeShortcutsEl.contains(active) && active !== startTimeInput)){
								timeShortcutsEl.style.display = 'none';
							}
							if(endShortcutsEl && (!endShortcutsEl.contains(active) && active !== endTimeInput)){
								endShortcutsEl.style.display = 'none';
							}
						}catch(e){ /* ignore */ }
					}, 50)
				});

			})();
		});
		</script>

		</div>

		<script>
		(function(){
			function pad(n){return n<10?('0'+n):n}
			function formatLocalDateInput(d){
				return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate());
			}
			function formatLocalTimeInput(d){
				return pad(d.getHours())+':'+pad(d.getMinutes());
			}

			function setTimeToInput(targetId, hhmm){
				if(hhmm==='now'){
					const now = new Date();
					// if targetId === 'both', set both date and time to now
					return now;
				}
				const parts = hhmm.split(':');
				const d = new Date();
				d.setHours(parseInt(parts[0],10));
				d.setMinutes(parseInt(parts[1],10));
				d.setSeconds(0);
				return d;
			}

			function applyShortcut(target, time){
				if(target==='both'){
					const now = new Date();
					document.getElementById('data_inicio_date').value = formatLocalDateInput(now);
					document.getElementById('hora_inicio').value = formatLocalTimeInput(now);
					document.getElementById('data_fim_date').value = formatLocalDateInput(now);
					document.getElementById('hora_fim').value = formatLocalTimeInput(now);
					updateCarga();
					return;
				}
				const d = setTimeToInput(target, time);
				if(!d) return;
				if(target === 'hora_inicio'){
					document.getElementById('hora_inicio').value = formatLocalTimeInput(d);
				} else if(target === 'hora_fim'){
					document.getElementById('hora_fim').value = formatLocalTimeInput(d);
				}
				updateCarga();
			}

			// shortcuts display is controlled by focus on time inputs and closes after selection

			document.querySelectorAll('.time-shortcut').forEach(function(b){
				b.addEventListener('click', function(){
					const tgt = b.getAttribute('data-target');
					const time = b.getAttribute('data-time');
					applyShortcut(tgt, time);
					// close the related shortcuts HUD after choosing
					if(tgt==='hora_inicio' || tgt==='both') document.getElementById('start-shortcuts').style.display='none';
					if(tgt==='hora_fim' || tgt==='both') document.getElementById('end-shortcuts').style.display='none';
				});
			});

			// show shortcuts when focusing the time inputs
			document.getElementById('hora_inicio').addEventListener('focus', function(){ document.getElementById('start-shortcuts').style.display='block'; });
			document.getElementById('hora_fim').addEventListener('focus', function(){ document.getElementById('end-shortcuts').style.display='block'; });

			// also hide shortcuts when pressing Escape
			document.addEventListener('keydown', function(e){ if(e.key === 'Escape'){ document.getElementById('start-shortcuts').style.display='none'; document.getElementById('end-shortcuts').style.display='none'; } });

			// close buttons for shortcuts
			document.querySelectorAll('.close-shortcuts').forEach(function(b){
				b.addEventListener('click', function(){
					var t = b.getAttribute('data-target');
					var el = document.getElementById(t);
					if(el) el.style.display = 'none';
				});
			});

			// auto-update carga when date/time change
			function updateCarga(){
				const di = document.getElementById('data_inicio_date').value;
				const hi = document.getElementById('hora_inicio').value;
				const df = document.getElementById('data_fim_date').value;
				const hf = document.getElementById('hora_fim').value;
				if(!di || !hi || !df || !hf){ document.getElementById('carga-preview').textContent = 'Carga: ‚Äî'; return; }
				// build local dates to avoid timezone parse differences
				const [yi,mi,diay] = di.split('-').map(Number);
				const [hiH,hiM] = hi.split(':').map(Number);
				const [yf,mf,dfay] = df.split('-').map(Number);
				const [hfH,hfM] = hf.split(':').map(Number);
				const start = new Date(yi, mi-1, diay, hiH, hiM, 0);
				const end = new Date(yf, mf-1, dfay, hfH, hfM, 0);
				const mins = Math.round((end - start)/60000);
				if(isNaN(mins) || mins <= 0){ document.getElementById('carga-preview').textContent = 'Carga: inv√°lida'; return; }
				if(mins < 60){ document.getElementById('carga-preview').textContent = 'Carga: '+mins+' minutos'; }
				else if(mins % 60 === 0){ document.getElementById('carga-preview').textContent = 'Carga: '+(mins/60)+' horas'; }
				else { document.getElementById('carga-preview').textContent = 'Carga: '+Math.floor(mins/60)+'h '+(mins%60)+'m'; }
			}

			document.getElementById('data_inicio_date').addEventListener('change', updateCarga);
			document.getElementById('hora_inicio').addEventListener('change', updateCarga);
			document.getElementById('data_fim_date').addEventListener('change', updateCarga);
			document.getElementById('hora_fim').addEventListener('change', updateCarga);

			// client-side ensure banner required and validate extension
			document.getElementById('create-event-form').addEventListener('submit', function(e){
				e.preventDefault();
				const form = e.target;
				const banner = document.getElementById('ev-banner');
				const hasFile = banner && banner.files && banner.files.length > 0;
				// require banner only when creating a new event
				if(!window.evEditMode){
					if(!hasFile){ alert('Banner √© obrigat√≥rio.'); return false; }
				}
				const allowed = ['.png','.jpg','.jpeg','.gif','.webp','.bmp','.tiff','.tif'];
				if(hasFile){
					const name = banner.files[0].name.toLowerCase();
					if(!allowed.some(ext=>name.endsWith(ext))){ alert('Formato de banner n√£o suportado.'); return false; }
				}
				const nome = document.getElementById('ev-nome').value.trim();
				const desc = document.getElementById('ev-descricao').value.trim();
				if(!nome || !desc){ alert('Nome e descri√ß√£o s√£o obrigat√≥rios.'); return false; }
				// ensure dates are valid
				const di = document.getElementById('data_inicio_date').value;
				const hi = document.getElementById('hora_inicio').value;
				const df = document.getElementById('data_fim_date').value;
				const hf = document.getElementById('hora_fim').value;
				if(!di||!hi||!df||!hf){ alert('Preencha data e hora de in√≠cio e fim.'); return false; }
				const [yi,mi,diay] = di.split('-').map(Number);
				const [hiH,hiM] = hi.split(':').map(Number);
				const [yf,mf,dfay] = df.split('-').map(Number);
				const [hfH,hfM] = hf.split(':').map(Number);
				const start = new Date(yi, mi-1, diay, hiH, hiM, 0);
				const end = new Date(yf, mf-1, dfay, hfH, hfM, 0);
				if(end<=start){ alert('Data/hora de fim deve ser posterior √† de in√≠cio.'); return false; }
				// attach combined datetime values into hidden inputs so server receives full datetimes
				let hiddenStart = document.getElementById('hidden_start');
				let hiddenEnd = document.getElementById('hidden_end');
				if(!hiddenStart){ hiddenStart = document.createElement('input'); hiddenStart.type='hidden'; hiddenStart.name='data_inicio'; hiddenStart.id='hidden_start'; form.appendChild(hiddenStart); }
				if(!hiddenEnd){ hiddenEnd = document.createElement('input'); hiddenEnd.type='hidden'; hiddenEnd.name='data_fim'; hiddenEnd.id='hidden_end'; form.appendChild(hiddenEnd); }
				// build local date/time strings (no timezone) so server keeps the wall-clock values
				const startDt = new Date(Number(yi), Number(mi)-1, Number(diay), Number(hiH), Number(hiM), 0);
				const endDt = new Date(Number(yf), Number(mf)-1, Number(dfay), Number(hfH), Number(hfM), 0);
				function localIsoNoTZ(d){
					function pad(n){return n<10?('0'+n):n}
					return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+'T'+pad(d.getHours())+':'+pad(d.getMinutes())+':00'
				}
				hiddenStart.value = localIsoNoTZ(startDt);
				hiddenEnd.value = localIsoNoTZ(endDt);
				// build FormData and submit via fetch so we can update UI without reload
				const fd = new FormData(form);
				fetch(window.location.href, {method: 'POST', body: fd, credentials: 'same-origin', headers: {'X-Requested-With': 'XMLHttpRequest'}})
				.then(async r => {
					const text = await r.text();
					const ct = (r.headers.get('content-type') || '');
					if(ct.indexOf('application/json') !== -1){
						try{ return JSON.parse(text); }catch(e){ return { status: 'error', message: 'Resposta JSON inv√°lida', debug: text, status_code: r.status }; }
					}
					// not JSON: return object containing raw text for debugging
					return { status: 'error', message: 'Resposta inesperada do servidor', debug: text, status_code: r.status };
				})
				.then(j => {
					if(j && j.status === 'ok' && j.evento){
						// update counters
						try{
							const bigNums = document.querySelectorAll('.stats .stat > div:first-child');
							const evtEl = bigNums && bigNums[0];
							const insEl = bigNums && bigNums[1];
							if(evtEl){ evtEl.textContent = (typeof j.total_eventos !== 'undefined' ? j.total_eventos : evtEl.textContent); }
							if(insEl && typeof j.total_inscricoes !== 'undefined'){ insEl.textContent = j.total_inscricoes; }
						}catch(e){console.error(e)}
						// insert new row into recent events table (prepend) or update existing row if editing
						try{
							function fmt(dtStr){ if(!dtStr) return ''; try{ var d = new Date(dtStr); function p(n){return n<10?('0'+n):n} return p(d.getDate())+'/'+p(d.getMonth()+1)+'/'+p(d.getFullYear())+' '+p(d.getHours())+':'+p(d.getMinutes()); }catch(e){ return dtStr; }}
							const tbody = document.querySelector('.recent tbody');
							if(tbody){
								const ev = j.evento;
								// if a row with same id exists, replace it (covers both edit and accidental duplicates)
								const existing = document.querySelector('tr[data-ev-id="'+ev.id+'"]');
								if(existing){
									existing.innerHTML = `<td><div style="font-weight:700">${ev.nome}</div><div style="color:#007acc; font-size:0.9rem;">Respons√°vel: ${ev.responsavel_name || ''}</div></td><td>${fmt(ev.data_inicio)}</td><td>${ev.vagas}</td><td>${ev.carga_horaria_minutos} min</td><td>${formActionsHtml(ev.id)}</td>`;
								} else {
									const tr = document.createElement('tr'); tr.setAttribute('data-ev-id', ev.id);
									tr.innerHTML = `<td><div style="font-weight:700">${ev.nome}</div><div style="color:#007acc; font-size:0.9rem;">Respons√°vel: ${ev.responsavel_name || ''}</div></td><td>${fmt(ev.data_inicio)}</td><td>${ev.vagas}</td><td>${ev.carga_horaria_minutos} min</td><td>${formActionsHtml(ev.id)}</td>`;
									// prepend
									if(tbody.firstChild) tbody.insertBefore(tr, tbody.firstChild); else tbody.appendChild(tr);
								}
							}
						}catch(e){console.error('failed to insert/update row', e)}
						// reset form/hide HUD (call shared reset so editing state is cleared)
						try{ if(window.resetEventForm) window.resetEventForm(); else { document.getElementById('create-event-form').reset(); document.getElementById('events-hud').style.display='none'; } }catch(e){}
					} else if(j && j.status === 'error'){
						alert(j.message || j.debug || 'Falha ao criar evento'); console.error(j);
					} else {
						alert(j.message || j.debug || 'Falha ao criar evento'); console.error(j);
					}
				})
				.catch(err=>{ console.error(err); alert('Erro ao criar evento'); });
			});

		})();
			</script>
			<script>
			// helper to build actions HTML for newly inserted rows
			const inscritosUrlTemplate = "{% url 'admin_event_inscritos' 0 %}";
			function formActionsHtml(id){
				try{
					const url = inscritosUrlTemplate.replace(/0(?!.*0)/, id);
					return `<a class="btn" href="${url}" style="background:#17a2b8;color:#fff;margin-left:6px;">Ver inscritos</a>`;
				}catch(e){ return '' }
			}
			</script>
			<div class="stats">
			<div class="stat"><div style="font-size:28px;font-weight:700">{{ total_eventos }}</div><div>Eventos</div></div>
			<div class="stat"><div style="font-size:28px;font-weight:700">{{ total_inscricoes }}</div><div>Inscri√ß√µes</div></div>
		</div>
				<!-- site confirm modal (so confirmable buttons in this page use the same UI) -->
				<div id="site-confirm-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:9998;align-items:center;justify-content:center;">
				  <div id="site-confirm" style="background:#fff;padding:18px;border-radius:10px;max-width:420px;width:94%;box-shadow:0 12px 40px rgba(0,0,0,0.2);">
					<div id="site-confirm-msg" style="font-size:1rem;color:#222;margin-bottom:12px;"></div>
					<div style="display:flex;gap:10px;justify-content:flex-end;">
					  <button id="site-confirm-no" class="btn secondary" style="background:transparent;color:#b30000;border:1px solid rgba(0,0,0,0.06);">N√£o</button>
					  <button id="site-confirm-yes" class="btn" style="background:#28a745;">Sim</button>
					</div>
				  </div>
				</div>
				<div class="recent">
						<h3 style="display:flex;align-items:center;justify-content:space-between;">
							<span>Eventos recentes</span>
							<button id="toggle-recent-list" class="btn" style="padding:6px 10px;">Ocultar</button>
						</h3>
						<table style="width:100%; margin-top:8px;">
				<thead><tr><th>Nome</th><th>In√≠cio</th><th>Vagas</th><th>Carga</th><th>A√ß√µes</th></tr></thead>
				<tbody>
				{% for ev in recent_events %}
				<tr data-ev-id="{{ ev.id }}">
					<td>
						<div style="font-weight:700">{{ ev.nome }}</div>
						<div style="color:#007acc; font-size:0.9rem;">Respons√°vel: {{ ev.responsavel.get_full_name|default:ev.responsavel.username }}</div>
					</td>
					<td>{{ ev.data_inicio|date:"d/m/Y H:i" }}</td>
					<td>{{ ev.vagas }}</td>
					<td>{{ ev.carga_horaria_minutos }} min</td>
					<td>
						{% if can_create %}
						<button class="btn edit-ev" data-ev='{"id":{{ ev.id }},"nome":"{{ ev.nome|escapejs }}","descricao":"{{ ev.descricao|escapejs }}","data_inicio":"{{ ev.data_inicio|date:"c" }}","data_fim":"{{ ev.data_fim|date:"c" }}","local":"{{ ev.local|escapejs }}","vagas":{{ ev.vagas }},"responsavel_id":{{ ev.responsavel_id }},"responsavel_name":"{{ ev.responsavel.get_full_name|default:ev.responsavel.username|escapejs }}"}' title="Editar">üî®</button>
						{% endif %}
						<a class="btn" href="{% url 'admin_event_inscritos' ev.id %}" style="background:#17a2b8;color:#fff;margin-left:6px;">Ver inscritos</a>
						{% if can_create %}
						<form method="post" style="display:inline">
							{% csrf_token %}
							<input type="hidden" name="action" value="delete_event">
							<input type="hidden" name="event_id" value="{{ ev.id }}">
							<button class="btn confirmable" type="submit" data-confirm="Tem certeza que deseja remover este evento? Esta a√ß√£o n√£o pode ser desfeita." style="background:#c33;border:none;">Remover</button>
						</form>
						{% endif %}
					</td>
				</tr>
				{% empty %}
				<tr><td colspan="5">Nenhum evento encontrado.</td></tr>
				{% endfor %}
				</tbody>
			</table>
		</div>
	</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
	const toggle = document.getElementById('toggle-recent-list');
	const recent = document.querySelector('.recent table');
	if(toggle && recent){
		let shown = true;
		toggle.addEventListener('click', function(){
			shown = !shown;
			recent.style.display = shown ? 'table' : 'none';
			toggle.textContent = shown ? 'Ocultar' : 'Mostrar';
		});
	}

	// handle delete-event forms via fetch so removal is reliable and avoids raw Django pages
	document.addEventListener('submit', function(ev){
		const f = ev.target;
		if(!(f && f.querySelector)) return;
		const actionInput = f.querySelector('input[name="action"]');
		if(actionInput && actionInput.value === 'delete_event'){
			ev.preventDefault();
			const fd = new FormData(f);
			const eid = fd.get('event_id');
			fetch(window.location.href, {method:'POST', body: fd, credentials: 'same-origin', headers: {'X-CSRFToken': fd.get('csrfmiddlewaretoken')}})
			.then(function(res){
				if(res.ok){
					try{
						// remove table row
						const row = document.querySelector('tr[data-ev-id="'+eid+'"]');
						if(row) row.remove();
						// decrement counters if present
						try{
							const bigNums = document.querySelectorAll('.stats .stat > div:first-child');
							const evtEl = bigNums && bigNums[0];
							const insEl = bigNums && bigNums[1];
							if(evtEl){ let n = parseInt(evtEl.textContent||0,10); if(!isNaN(n) && n>0){ evtEl.textContent = (n-1); } }
							if(insEl){ let n = parseInt(insEl.textContent||0,10); if(!isNaN(n) && n>0){ insEl.textContent = (n-0); } }
						}catch(e){ console.error('counter update failed', e); }
					}catch(e){ console.error('UI update after delete failed', e); }
				} else {
					return res.text().then(t=>{ alert('Falha ao remover evento'); console.error(t); });
				}
			})
			.catch(function(err){ console.error('Erro ao remover evento', err); alert('Erro ao remover evento'); });
		}
	}, true);
});
</script>
	<script>
	// wire the modal to intercept confirmable submits (capture phase)
	document.addEventListener('DOMContentLoaded', function(){
		try{
			document.addEventListener('submit', function(ev){
				const f = ev.target;
				if(f && f.classList && f.classList.contains('confirmable')){
					ev.preventDefault();
					const overlay = document.getElementById('site-confirm-overlay');
					const msg = document.getElementById('site-confirm-msg');
					const yes = document.getElementById('site-confirm-yes');
					const no = document.getElementById('site-confirm-no');
					const text = f.getAttribute('data-confirm') || 'Tem certeza?';
					if(!(overlay && msg && yes && no)){
						if(!window.confirm(text)) return; try{ f.classList.remove('confirmable'); }catch(e){}; var ev2 = new Event('submit', { bubbles:true, cancelable:true }); var proceed = f.dispatchEvent(ev2); if(proceed){ try{ f.submit(); }catch(e){} };
						return;
					}
					msg.textContent = text; overlay.style.display = 'flex';
					function cleanup(){ overlay.style.display='none'; yes.removeEventListener('click', onYes); no.removeEventListener('click', onNo); }
					function onYes(){ cleanup(); try{ f.classList.remove('confirmable'); }catch(e){}; var ev2 = new Event('submit', { bubbles:true, cancelable:true }); var proceed = f.dispatchEvent(ev2); if(proceed){ try{ f.submit(); }catch(e){} } }
					function onNo(){ cleanup(); }
					yes.addEventListener('click', onYes);
					no.addEventListener('click', onNo);
				}
			}, true);

			// also intercept clicks on confirmable buttons to show modal before form submits
			document.addEventListener('click', function(ev){
				const btn = ev.target.closest && ev.target.closest('.confirmable');
				if(!btn) return;
				const f = btn.closest('form');
				if(!f) return;
				ev.preventDefault();
				const overlay = document.getElementById('site-confirm-overlay');
				const msg = document.getElementById('site-confirm-msg');
				const yes = document.getElementById('site-confirm-yes');
				const no = document.getElementById('site-confirm-no');
				const text = f.getAttribute('data-confirm') || btn.getAttribute('data-confirm') || 'Tem certeza?';
				if(!(overlay && msg && yes && no)){
					if(!window.confirm(text)) return; try{ f.classList.remove('confirmable'); }catch(e){}; f.submit(); return;
				}
				msg.textContent = text; overlay.style.display = 'flex';
				function cleanup(){ overlay.style.display='none'; yes.removeEventListener('click', onYes); no.removeEventListener('click', onNo); }
				function onYes(){ cleanup(); try{ f.classList.remove('confirmable'); }catch(e){}; f.submit(); }
				function onNo(){ cleanup(); }
				yes.addEventListener('click', onYes);
				no.addEventListener('click', onNo);
			}, true);
		}catch(e){ console.error('admin confirm wiring failed', e); }
	});
	</script>
</body>
</html>
