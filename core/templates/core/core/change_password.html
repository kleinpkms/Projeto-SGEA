<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Alterar Senha</title>
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
  <div class="container">
    <h2>Alterar Senha</h2>
    {% if success %}<div class="alert alert-success">Senha alterada com sucesso.</div>{% endif %}
    {% if error %}<div class="alert alert-danger">{{ error }}</div>{% endif %}
    {% if not code_requested and not verification %}
    <form method="post" class="confirmable" data-confirm="Deseja solicitar o código para alterar a senha?">
      {% csrf_token %}
      <input type="hidden" name="action" value="request_code">
      <div><label>Senha atual</label><input name="current_password" type="password" required></div>
      <div style="margin-top:12px;"><button class="btn" type="submit">Solicitar código</button> <a href="/perfil/" class="btn">Cancelar</a></div>
    </form>
    {% else %}
    <!-- confirmation step: enter code + new password -->
    <form method="post" class="confirmable" data-confirm="Confirma a alteração da senha com o código informado?">
      {% csrf_token %}
      <input type="hidden" name="action" value="confirm_code">
      <input type="hidden" name="verification_id" value="{{ verification.id }}">
      <div><label>Código recebido por e-mail</label><input name="code" type="text" required></div>
      <div><label>Nova senha</label><input name="new_password" type="password" required></div>
      <div><label>Confirmar nova senha</label><input name="new_password_confirm" type="password" required></div>
      <div style="margin-top:12px;"><button class="btn" type="submit">Confirmar e alterar</button> <a href="/perfil/" class="btn">Cancelar</a></div>
    </form>
    {% endif %}
  </div>
  <!-- include site confirm modal so confirmable forms on this page show the same popup -->
  <div id="site-confirm-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:9998;align-items:center;justify-content:center;">
    <div id="site-confirm" style="background:#fff;padding:18px;border-radius:10px;max-width:420px;width:94%;box-shadow:0 12px 40px rgba(0,0,0,0.2);">
      <div id="site-confirm-msg" style="font-size:1rem;color:#222;margin-bottom:12px;"></div>
      <div style="display:flex;gap:10px;justify-content:flex-end;">
        <button id="site-confirm-no" class="btn secondary" style="background:transparent;color:#b30000;border:1px solid rgba(0,0,0,0.06);">Não</button>
        <button id="site-confirm-yes" class="btn" style="background:#28a745;">Sim</button>
      </div>
    </div>
  </div>
  <script>
    (function(){
      const overlay = document.getElementById('site-confirm-overlay');
      const msg = document.getElementById('site-confirm-msg');
      const yes = document.getElementById('site-confirm-yes');
      const no = document.getElementById('site-confirm-no');
      let resolveCb = null;
      function showConfirm(text){ return new Promise(function(resolve){ msg.textContent = text||'Tem certeza?'; overlay.style.display='flex'; resolveCb = resolve; }); }
      function hide(){ overlay.style.display='none'; resolveCb=null; }
      no.addEventListener('click', function(){ if(resolveCb) resolveCb(false); hide(); });
      yes.addEventListener('click', function(){ if(resolveCb) resolveCb(true); hide(); });
      document.addEventListener('submit', function(ev){ const f = ev.target; if(f && f.classList && f.classList.contains('confirmable')){ ev.preventDefault(); const txt = f.getAttribute('data-confirm') || 'Tem certeza?'; showConfirm(txt).then(function(ok){ if(!ok) return; try{ f.classList.remove('confirmable'); }catch(e){}; var ev2 = new Event('submit', { bubbles:true, cancelable:true }); var proceed = f.dispatchEvent(ev2); if(proceed){ try{ f.submit(); }catch(e){} } }); } }, true);
    })();
    // reveal confirm block if user clicks 'Já tenho código'
    document.getElementById('reveal-confirm').addEventListener('click', function(){ document.getElementById('confirm-block').style.display = 'block'; this.style.display = 'none'; });
  </script>
</body>
</html>
