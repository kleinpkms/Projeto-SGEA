<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Dados Pessoais</title>
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
  <div class="container">
    <h2>Dados Pessoais</h2>
    {% if msg %}<div class="alert alert-success">{{ msg }}</div>{% endif %}
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
        {% if profile and profile.photo %}
          <img src="{{ profile.photo.url }}" alt="Foto" style="width:72px;height:72px;object-fit:cover;border-radius:999px;border:1px solid #e6e6e6;">
        {% else %}
          <div style="width:72px;height:72px;border-radius:999px;background:#eaf4fb;color:#0a58ca;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.3rem;border:1px solid #e6e6e6;">{{ request.user.first_name|default:request.user.username|slice:":1"|upper }}</div>
        {% endif %}
      </div>
      <div><label>Nome</label><input name="first_name" value="{{ request.user.first_name }}" required></div>
      <div><label>Sobrenome</label><input name="last_name" value="{{ request.user.last_name }}" required></div>
      <div><label>Telefone</label><input name="telefone" value="{{ profile.telefone|default:'' }}" placeholder="(XX) XXXXX-XXXX" pattern="\([0-9]{2}\) [0-9]{4,5}-[0-9]{4}"></div>
        <div><label>Data de Nascimento</label><input name="data_nascimento" type="date" value="{% if profile.data_nascimento %}{{ profile.data_nascimento|date:'Y-m-d' }}{% endif %}"></div>
      <div><label>Foto de Perfil</label><input type="file" name="photo" accept="image/png,image/jpeg"></div>
      <div style="margin-top:12px;"><button class="btn" type="submit">Salvar</button> <a href="/home/" class="btn">Voltar</a></div>
    </form>
    <div style="margin-top:18px;">
      <a href="{% url 'alterar_senha' %}" class="btn">Alterar senha</a>
    </div>
  </div>
  <script>
  // improve HUD: add phone mask/validation similar to registration
  function phoneMask(v){ v = v.replace(/\D/g,'').slice(0,11); if(v.length<=2) return '('+v; if(v.length<=6) return '('+v.slice(0,2)+') '+v.slice(2); return '('+v.slice(0,2)+') '+v.slice(2,7)+'-'+v.slice(7); }
  const profileTel = document.querySelector('input[name="telefone"]');
  if(profileTel){
    profileTel.addEventListener('input', function(){ this.value = phoneMask(this.value); });
    profileTel.placeholder = '(XX) XXXXX-XXXX';
  }

  // client-side validation on profile save: ensure telefone has >=10 digits when present and does not start with 55
  document.querySelector('form').addEventListener('submit', function(e){
    const tel = profileTel ? (profileTel.value||'') : '';
    if(tel){
      const digits = tel.replace(/\D/g,'');
      if(digits.startsWith('55')){ e.preventDefault(); alert('Não inclua o código do país (55). Informe apenas o DDD entre parênteses e o número.'); return false; }
      const digitsLocal = digits;
      if(digitsLocal.length && digitsLocal.length < 10){ e.preventDefault(); alert('Telefone inválido: deve conter ao menos 10 dígitos.'); return false; }
    }
  });
  </script>
</body>
</html>
